---
title: '无人机软件仿真'
date: 2025-12-21T23:30:30+08:00
tags: ["AirSim", "PX4", "ROS2", "WSL2", "仿真"]
categories: ["无人机", "自动驾驶", "开发环境搭建"]
draft: true
---

在无人机自主飞行系统开发中，高保真仿真平台是验证算法和系统集成的关键环节。本文记录了在 Windows + WSL2 环境下，基于 **AirSim**、**PX4** 与 **ROS 2 Humble** 构建完整无人机软件仿真链路的全过程，涵盖环境搭建、系统配置与协同运行步骤。

## 1. AirSim 在 Windows 上的安装与配置

AirSim 是由 Microsoft 开发的开源高保真仿真平台，支持无人机与无人车等多种载具，基于 Unreal Engine 构建，可与 PX4 飞控无缝集成[^1]。

### 1.1 基础依赖安装

- 从 [Epic Games Launcher](https://www.unrealengine.com/) 安装 **Unreal Engine 4.27 或更高版本**。
- 安装 **Visual Studio 2022**，确保勾选以下组件：
  - **Desktop development with C++**
  - **Windows 10 SDK (10.0.19041)**
  - 在“Individual Components”中勾选最新版 **.NET Framework SDK**

> **注意**：建议将 AirSim 克隆到非系统盘（如 `D:\` 或 `E:\`），避免权限问题。

### 1.2 编译 AirSim 插件

打开 **Developer Command Prompt for VS 2022**，执行以下命令：

```bash
git clone https://github.com/Microsoft/AirSim.git
cd AirSim
build.cmd
```

该脚本将在 `AirSim/Unreal/Plugins` 目录下生成可直接使用的插件。

### 1.3 集成到 Unreal 场景

1. 从 Epic 商店下载或创建一个 Unreal 场景项目（如 `Blocks`）。
2. 将上述生成的 `Plugins/AirSim` 文件夹复制到你的 Unreal 项目根目录下的 `Plugins/` 文件夹中。
3. 重启 Unreal Editor，确保插件已启用。

### 1.4 配置 PX4 仿真模式

创建或修改 AirSim 的配置文件 `settings.json`（位于 `%USERPROFILE%\Documents\AirSim\`），内容参考如下[^2]：

```json
{
    "SettingsVersion": 1.2,
    "SimMode": "Multirotor",
    "ClockType": "SteppableClock",
    "Vehicles": {
        "PX4": {
            "VehicleType": "PX4Multirotor",
            "UseSerial": false,
            "LockStep": true,
            "UseTcp": true,
            "TcpPort": 4560,
            "ControlPortLocal": 14540,
            "ControlPortRemote": 14580,
            "Cameras": {
                "CameraDepth": {
                    "CaptureSettings": [
                        {
                        "ImageType": 2,
                        "Width": 800,
                        "Height": 600,
                        "FOV_Degrees": 120,
                        "AutoExposureSpeed": 100,
                        "AutoExposureBias": 0,
                        "AutoExposureMaxBrightness": 0.64,
                        "AutoExposureMinBrightness": 0.03,
                        "MotionBlurAmount": 0,
                        "TargetGamma": 1.0,
                        "ProjectionMode": "",
                        "OrthoWidth": 5.12
                        }
                    ],
                    "NoiseSettings": [
                        {
                        "Enabled": false,
                        "ImageType": 0,

                        "RandContrib": 0.2,
                        "RandSpeed": 100000.0,
                        "RandSize": 500.0,
                        "RandDensity": 2,

                        "HorzWaveContrib":0.03,
                        "HorzWaveStrength": 0.08,
                        "HorzWaveVertSize": 1.0,
                        "HorzWaveScreenSize": 1.0,

                        "HorzNoiseLinesContrib": 1.0,
                        "HorzNoiseLinesDensityY": 0.01,
                        "HorzNoiseLinesDensityXY": 0.5,

                        "HorzDistortionContrib": 1.0,
                        "HorzDistortionStrength": 0.002
                        }
                    ],
                    "Gimbal": {
                        "Stabilization": 0,
                        "Pitch": 0, "Roll": 0, "Yaw": 0
                    },
                    "X": 0, "Y": 0, "Z": -1,
                    "Pitch": 0, "Roll": 0, "Yaw": 0,
                    "UnrealEngine": {
                        "PixelFormatOverride": [
                            {
                                "ImageType": 0,
                                "PixelFormat": 0
                            }
                        ]
                    }
                },
                "CameraImage": {
                    "CaptureSettings": [
                        {
                        "ImageType": 0,
                        "Width": 800,
                        "Height": 600,
                        "FOV_Degrees": 120,
                        "AutoExposureSpeed": 100,
                        "AutoExposureBias": 0,
                        "AutoExposureMaxBrightness": 0.64,
                        "AutoExposureMinBrightness": 0.03,
                        "MotionBlurAmount": 0,
                        "TargetGamma": 1.0,
                        "ProjectionMode": "",
                        "OrthoWidth": 5.12
                        }
                    ],
                    "X": 0, "Y": 0, "Z": -1,
                    "Pitch": 0, "Roll": 0, "Yaw": 0
                }
            },
            "Sensors":{
                "Magnetometer": {
                    "SensorType": 4,
                    "Enabled": true
                },
                "Barometer":{
                    "SensorType": 1,
                    "Enabled": true,
                    "PressureFactorSigma": 0.0001825
                },
                "Imu": {
                    "SensorType": 2,
                    "Enabled" : true,
                    "AngularRandomWalk": 0.3,
                    "GyroBiasStabilityTau": 500,
                    "GyroBiasStability": 4.6,
                    "VelocityRandomWalk": 0.24,
                    "AccelBiasStabilityTau": 800,
                    "AccelBiasStability": 36
                },
                "Gps": {
                    "SensorType": 3,
                    "Enabled" : true,
                    "EphTimeConstant": 0.9,
                    "EpvTimeConstant": 0.9,
                    "EphInitial": 25,
                    "EpvInitial": 25,
                    "EphFinal": 0.1,
                    "EpvFinal": 0.1,
                    "EphMin3d": 3,
                    "EphMin2d": 4,
                    "UpdateLatency": 0.2,
                    "UpdateFrequency": 50,
                    "StartupDelay": 1
                },
                "Lidar": {
                    "SensorType": 6,
                    "Enabled": true,
                    "NumberOfChannels": 16,
                    "RotationsPerSecond": 10,
                    "PointsPerSecond": 100000,
                    "X": 0, "Y": 0, "Z": -1,
                    "Roll": 0, "Pitch": 0, "Yaw": 0,
                    "VerticalFOVUpper": 10,
                    "VerticalFOVLower": -10,
                    "HorizontalFOVStart": -20,
                    "HorizontalFOVEnd": 20,
                    "DrawDebugPoints": true,
                    "DataFrame": "SensorLocalFrame"
                },
                "DistanceDown": {
                    "SensorType": 5,
                    "Enabled" : true,
                    "MinDistance": 0.1,
                    "MaxDistance": 40,
                    "X": 0, "Y": 0, "Z": -0.5,
                    "Yaw": 0, "Pitch": -90, "Roll": 0,
                    "DrawDebugPoints": true,
                    "ExternalController": true
                }
            },
            "Parameters": {
                "NAV_RCL_ACT": 0,
                "NAV_DLL_ACT": 0,
                "COM_OBL_ACT": 0,
                "COM_OBS_AVOID": 0
            }
        }
    }
}
```

> 此配置启用 PX4 SITL（Software-in-the-Loop）模式，通过 TCP 通信，并关闭遥控器失联动作，使无人机在任务完成后悬停而非降落。

## 2. PX4 SITL 仿真环境（WSL2 + Ubuntu 22.04）

在 Windows 上启用 **WSL2** 并安装 **Ubuntu 22.04**，用于运行 PX4 仿真。

### 2.1 安装 PX4 工具链

```bash
git clone https://github.com/PX4/PX4-Autopilot.git --recursive
cd PX4-Autopilot
bash ./Tools/setup/ubuntu.sh
```

> 可选参数：`--no-nuttx --no-sim-tools` 跳过嵌入式与仿真工具安装。安装完成后**重启 WSL2**（或整机）。

### 2.2 启动 PX4 SITL

```bash
cd ~/PX4-Autopilot
make px4_sitl_default none_iris
```

此命令启动 PX4 固件，加载 `iris` 无人机模型，并默认监听 UDP 端口（如 14540、14550），用于与 AirSim 通信。

## 3. ROS 2 与 PX4 的桥接：Micro XRCE-DDS

PX4 通过 **uXRCE-DDS** 协议与 ROS 2 通信。需在 WSL2 中运行 **Micro XRCE-DDS Agent** 作为中间代理。

### 3.1 编译并安装 Agent

```bash
git clone -b v2.4.3 https://github.com/eProsima/Micro-XRCE-DDS-Agent.git
cd Micro-XRCE-DDS-Agent
mkdir build && cd build
cmake ..
make
sudo make install
sudo ldconfig /usr/local/lib/
```

### 3.2 启动 Agent

```bash
MicroXRCEAgent udp4 -p 8888
```

> PX4 在 SITL 模式下默认通过 UDP 向 `localhost:8888` 发送 uXRCE-DDS 客户端消息。Agent 接收后桥接到 ROS 2 DDS 网络。

## 4. ROS 2 Humble 安装与配置（WSL2）

参考 ROS 2 官方文档安装 Humble 版本[^3]。

### 4.1 添加源并安装

```bash
sudo apt install software-properties-common
sudo add-apt-repository universe
sudo apt update && sudo apt install curl -y

export ROS_APT_SOURCE_VERSION=$(curl -s https://api.github.com/repos/ros-infrastructure/ros-apt-source/releases/latest | grep -F "tag_name" | awk -F\" '{print $4}')
curl -L -o /tmp/ros2-apt-source.deb "https://github.com/ros-infrastructure/ros-apt-source/releases/download/${ROS_APT_SOURCE_VERSION}/ros2-apt-source_${ROS_APT_SOURCE_VERSION}.$(. /etc/os-release && echo ${UBUNTU_CODENAME:-${VERSION_CODENAME}})_all.deb"
sudo dpkg -i /tmp/ros2-apt-source.deb
sudo apt update

sudo apt install -y ros-humble-desktop
sudo apt install -y ros-dev-tools \
  ros-humble-geographic-msgs \
  ros-humble-topic-tools \
  ros-humble-topic-tools-interfaces \
  ros-humble-mavros \
  ros-humble-mavros-msgs
```

### 4.2 初始化环境

```bash
echo "source /opt/ros/humble/setup.bash" >> ~/.bashrc
source ~/.bashrc
pip install --user -U empy==3.3.4 pyros-genmsg setuptools
cd ~/hw-ros2/ros2/
colcon build
```

## 5. 系统联调与运行

完成上述配置后，按以下顺序启动各组件：

1. **启动 AirSim**  
   在 Windows 上运行配置好的 Unreal 项目（如 Blocks），确保加载 AirSim 插件并使用上述 `settings.json`。

2. **启动 PX4 SITL**（WSL2 新终端）  
   ```bash
   cd ~/PX4-Autopilot
   make px4_sitl_default none_iris
   ```

3. **启动 Micro XRCE-DDS Agent**（WSL2 新终端）  
   ```bash
   MicroXRCEAgent udp4 -p 8888
   ```

4. **启动 ROS 2 控制节点**（WSL2 新终端）  
   ```bash
   cd ~/hw-ros2/ros2
   source install/local_setup.sh
   ros2 launch hw_insight lesson3.launch.py
   ```

5. **启动键盘控制节点**（WSL2 新终端）  
   ```bash
   cd ~/hw-ros2/ros2
   source install/local_setup.sh
   ros2 run hw_insight keyboard_velocity
   ```
   > 保持该终端窗口获得焦点，即可通过键盘控制无人机运动。

## 6. 验证与调试建议

- 确保 PX4 成功获取“home 位置”（查看终端是否出现 `home_set` 提示），否则起飞会被拒绝。
- 若无人机到达目标后自动降落，检查 PX4 参数 `COM_OBL_ACT` 是否设为 `1`（悬停）而非默认值。
- 使用 `ros2 topic list` 和 `ros2 topic echo` 监听 `/fmu/*` 话题，确认 PX4 与 ROS 2 通信正常。

---

通过上述步骤，可在单机 Windows + WSL2 环境中构建完整的“AirSim ←→ PX4 ←→ ROS 2”仿真链路，为后续的感知、规划与控制算法开发提供可靠验证平台。

---

[^1]: Microsoft AirSim Documentation. [https://microsoft.github.io/AirSim/](https://microsoft.github.io/AirSim/)
[^2]: PX4 Setup for AirSim. [https://microsoft.github.io/AirSim/px4_setup/](https://microsoft.github.io/AirSim/px4_setup/)
[^3]: ROS 2 Humble Installation Guide. [https://docs.ros.org/en/humble/Installation/Ubuntu-Install-Debs.html](https://docs.ros.org/en/humble/Installation/Ubuntu-Install-Debs.html)